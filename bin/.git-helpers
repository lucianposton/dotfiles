#!/bin/bash

# The time massaging regexes start with ^[^<]* because that ensures that they
# only operate before the first "<". That "<" will be the beginning of the
# author name, ensuring that we don't destroy anything in the commit message
# that looks like time.
#
# The log format uses } characters between each field, and `column` is later
# used to split on them. A } in the commit subject or any other field will
# break this.

HASH="%C(yellow)%h%Creset"
RELATIVE_TIME="%Cgreen(%ar)%Creset"
AUTHOR="%C(bold blue)<%an>%Creset"
REFS="%C(bold red)%d%Creset"
SUBJECT="%s"

FORMAT="$HASH}$RELATIVE_TIME}$AUTHOR}$REFS $SUBJECT"
FORMAT_HEAD="${FORMAT//\}/ }"

ANSI_BLACK='\033[30m'
ANSI_BLACK_BOLD='\033[0;30;1m'
ANSI_RED='\033[31m'
ANSI_RED_BOLD='\033[0;31;1m'
ANSI_GREEN='\033[32m'
ANSI_GREEN_BOLD='\033[0;32;1m'
ANSI_YELLOW='\033[33m'
ANSI_YELLOW_BOLD='\033[0;33;1m'
ANSI_BLUE='\033[34m'
ANSI_BLUE_BOLD='\033[0;34;1m'
ANSI_MAGENTA='\033[35m'
ANSI_MAGENTA_BOLD='\033[0;35;1m'
ANSI_CYAN='\033[36m'
ANSI_CYAN_BOLD='\033[0;36;1m'
ANSI_WHITE='\033[37m'
ANSI_WHITE_BOLD='\033[0;37;1m'
ANSI_RESET='\033[0m'


show_git_head() {
    git show -p --pretty="tformat:${FORMAT_HEAD}" $*
}

# TODO: less paging seems busted in iterm2
pretty_git_log() {
    git log --color --graph --pretty="tformat:${FORMAT}" $* |
        # Replace (2 years ago) with (2 years)
        sed -Ee 's/(^[^<]*) ago\)/\1)/' |
        # Replace (2 years, 5 months) with (2 years)
        sed -Ee 's/(^[^<]*), [[:digit:]]+ .*months?\)/\1)/' |
        # Line columns up based on } delimiter
        #column -s '}' -t |
        awk -F '}' '
        {
            nf[NR]=NF
            for (i = 1; i <= NF; i++) {
                f[NR,i] = $i
                gsub(/\033\[[0-9;]*[mK]/, "", $i)
                len[NR,i] = l = length($i)
                if (l > max[i]) max[i] = l
                }
            }
            END {
            for (n = 1; n <= NR; n++) {
                for (i = 1; i < nf[n]; i++)
                    printf "%s%*s", f[n,i], max[i]+1-len[n,i], ""
                    print f[n,nf[n]]
                }
            }' |
        # Color merge commits specially
        sed -Ee "s/(Merge (remote-tracking )?branch .* into .*$)/$(printf $ANSI_RED)\1$(printf $ANSI_RESET)/" |
        # Page only if we need to
        less -RFXS
}
